name: Release

on:
  push:
    branches: [main]

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      release_created: ${{ steps.rp.outputs.release_created }}
      tag_name: ${{ steps.rp.outputs.tag_name }}
    steps:
      - id: rp
        uses: googleapis/release-please-action@v4

  frontend-build:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: cd frontend && npm ci && npm run build
      - uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

  build:
    name: Build (${{ matrix.os }})
    needs: [frontend-build]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            artifact: goldsplit-darwin-arm64.zip
          - os: windows-latest
            artifact: goldsplit-windows-amd64.zip
          - os: ubuntu-latest
            artifact: goldsplit-linux-amd64.tar.gz
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
      - name: Cache & install Linux deps
        if: runner.os == 'Linux'
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: libgtk-3-dev libwebkit2gtk-4.1-dev build-essential pkg-config
      - name: Cache Wails CLI
        id: cache-wails
        uses: actions/cache@v4
        with:
          path: ~/go/bin
          key: wails-${{ runner.os }}-v2.11.0
      - name: Install Wails CLI
        if: steps.cache-wails.outputs.cache-hit != 'true'
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0
      - name: Build
        run: wails build -s ${{ runner.os == 'Linux' && '-tags webkit2_41' || '' }} -ldflags "-X main.versionSuffix="

      - name: Package (macOS)
        if: runner.os == 'macOS'
        run: cd build/bin && zip -r ../../${{ matrix.artifact }} Goldsplit.app

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Compress-Archive -Path build\bin\Goldsplit.exe -DestinationPath ${{ matrix.artifact }}

      - name: Package (Linux)
        if: runner.os == 'Linux'
        run: mv build/bin/Goldsplit build/bin/goldsplit && tar -czf ${{ matrix.artifact }} -C build/bin goldsplit

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  publish-release:
    name: Publish Release
    needs: [release-please, build]
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          pattern: goldsplit-*
          path: artifacts
          merge-multiple: true
      - name: Upload binaries to versioned release
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: gh release upload "${{ needs.release-please.outputs.tag_name }}" artifacts/*
      - name: Append contributors to release notes
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          TAG: ${{ needs.release-please.outputs.tag_name }}
        run: |
          EXISTING=$(gh release view "$TAG" --json body -q .body)
          CONTRIBUTORS=$(git log --format='%aN' | sort -u | sed 's/^/- /')
          gh release edit "$TAG" --notes "$(cat <<NOTES
          ${EXISTING}

          ### Contributors
          ${CONTRIBUTORS}
          NOTES
          )"

  publish-dev-build:
    name: Publish Dev Build
    needs: [release-please, build]
    if: needs.release-please.outputs.release_created != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          pattern: goldsplit-*
          path: artifacts
          merge-multiple: true
      - name: Generate contributor list
        id: contributors
        run: |
          CONTRIBUTORS=$(git log --format='%aN' | sort -u | sed 's/^/- /')
          {
            echo 'list<<EOF'
            echo "$CONTRIBUTORS"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
      - name: Delete previous dev draft
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: gh release delete draft --yes 2>/dev/null || true
      - name: Create draft dev release
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh release create draft \
            --title "Development Build" \
            --draft \
            --prerelease \
            --target "${{ github.sha }}" \
            --notes "$(cat <<'NOTES'
          ## Development Build

          Built from `main` at ${{ github.sha }}.

          > **This is an automated pre-release build and may be unstable.**

          ### Contributors
          ${{ steps.contributors.outputs.list }}
          NOTES
          )" \
            artifacts/*
